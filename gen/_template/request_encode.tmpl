{{ define "request_encoders" }}
{{- /*gotype: github.com/ogen-go/ogen/gen.TemplateConfig*/ -}}
{{ $pkg := $.Package }}
{{ template "header" $ }}

{{- range $op := $.Operations }}{{ if $op.Request }}
func encode{{ $op.Name }}Request(
	req {{ $op.Request.Type.Go }},
	r *http.Request,
) error {
{{- $contents := $op.Request.Contents }}
{{- $requestsLength := len $contents }}

{{- if eq $requestsLength 1 }}
	{{- range $contentType, $media := $contents }}
		const contentType = {{ quote $contentType }}
		{{- template "encode_request" $media }}
	{{- end }}
{{- else }}
	{{- /* Multiple requests */}}
	switch req := req.(type) {
	{{- range $contentType, $media := $contents }}
	case *{{ $media.Type.Go }}:
		const contentType = {{ quote $contentType }}
    	{{- template "encode_request" $media }}
	{{- end }}
	default:
		return errors.Errorf("unexpected request type: %T", req)
	}
{{- end }}
}
{{- end }}{{ end }}
{{ end }}

{{- define "encode_request" }}
{{- /*gotype: github.com/ogen-go/ogen/gen/ir.Media*/ -}}
{{- $type := $.Type }}
{{- $contentType := $.Encoding }}
{{- $unaliased := $type }}{{- if $type.IsAlias }}{{ $unaliased = $type.AliasTo }}{{- end }}

{{- if $unaliased.GenericVariant.Optional }}
	if !req.Set {
		// Keep request with empty body if value is not set.
		return nil
	}
{{- end }}

{{- if $type.IsStream }}
	ht.SetBody(r, req, contentType)
	return nil
{{- else if $contentType.JSON }}
	e := jx.GetEncoder()
	{
	   {{- template "json/enc" elem $type "req" }}
	}
	encoded := e.Bytes()
	ht.SetBody(r, bytes.NewReader(encoded), contentType)
	return nil
{{- else if or $contentType.FormURLEncoded $contentType.MultipartForm }}
	{{- if $unaliased.IsGeneric }}
		request := req.Value
		{{ $type = $unaliased.GenericOf }}
	{{- else if $unaliased.IsStruct }}
		request := req
        {{ $type = $unaliased }}
	{{- else }}
        {{- errorf "unexpected type: %s" $unaliased }}
	{{- end }}
	q := uri.NewQueryEncoder()
	{{- range $param := $type.FormParameters }}
	{
		// Encode {{ quote $param.Spec.Name }} form field.
		cfg := uri.QueryParameterEncodingConfig{
			Name:    {{ quote $param.Spec.Name }},
			Style:   uri.QueryStyle{{ capitalize $param.Spec.Style.String }},
			Explode: {{ if $param.Spec.Explode }}true{{ else }}false{{ end }},
		}
		if err := q.EncodeParam(cfg, func(e uri.Encoder) error {
			{{- template "uri/encode" elem $param.Type (printf "request.%s" $param.Name) }}
		}); err != nil {
			return errors.Wrap(err, "encode query")
		}
	}
	{{- end }}
	{{- if $contentType.FormURLEncoded }}
		encoded := q.Values().Encode()
		ht.SetBody(r, strings.NewReader(encoded), contentType)
		return nil
	{{- else if $contentType.MultipartForm }}
		body, boundary := ht.CreateMultipartBody(func(w *multipart.Writer) error {
        	{{- range $param := $type.FileParameters }}
				{{- template "encode_multipart_file_param" $param }}
			{{- end }}
			if err := q.WriteMultipart(w); err != nil {
				return errors.Wrap(err, "write multipart")
			}
			return nil
		})
		ht.SetBody(r, body, mime.FormatMediaType(contentType, map[string]string{"boundary": boundary}))
		return nil
	{{- else }}
		{{- errorf "%s encoder not implemented" $contentType }}
	{{- end }}
{{- else }}
	{{- errorf "%s encoder not implemented" $contentType }}
{{- end }}

{{- end }}

{{- define "encode_multipart_file_param" }}
{{- /*gotype: github.com/ogen-go/ogen/gen/ir.Parameter*/ -}}
{{- $name := quote $.Spec.Name }}
{{- $errWrite := printf "write %s" $name | quote }}
{{- $recv := printf "request.%s" $.Name }}
{{- $t := $.Type }}

{{- if $t.IsPrimitive }}
	if err := {{ $recv }}.WriteMultipart({{ $name }}, w); err != nil {
		return errors.Wrap(err, {{ $errWrite }})
	}
{{- else if $t.IsGeneric }}
	if val, ok := {{ $recv }}.Get(); ok {
		if err := val.WriteMultipart({{ $name }}, w); err != nil {
			return errors.Wrap(err, {{ $errWrite }})
		}
	}
{{- else if $t.IsArray }}
	if err := func() error {
		for idx, val := range {{ $recv }} {
			if err := val.WriteMultipart({{ $name }}, w); err != nil {
				return errors.Wrapf(err, "file [%d]", idx)
			}
		}
		return nil
	}(); err != nil {
		return errors.Wrap(err, {{ $errWrite }})
	}
{{- else }}
    {{ errorf "unexpected kind %s" $t.Kind }}
{{- end }}
{{- end }}
